#!/bin/bash

echo "=========================================="
echo "POST-RUN SCRIPT - Environment Variable Check"
echo "=========================================="
echo ""

echo "Checking for TOWER_CONFIG_FILE environment variable:"
if [ -n "$TOWER_CONFIG_FILE" ]; then
    echo "  ✓ TOWER_CONFIG_FILE is set to: $TOWER_CONFIG_FILE"
    
    if [ -f "$TOWER_CONFIG_FILE" ]; then
        echo "  ✓ File exists!"
        echo ""
        echo "Content of TOWER_CONFIG_FILE:"
        echo "---START---"
        cat "$TOWER_CONFIG_FILE"
        echo "---END---"
        echo ""
        
        echo "Attempting to parse parameters:"
        INPUT=$(grep -E "^\s*input\s*=" "$TOWER_CONFIG_FILE" | sed 's/.*=\s*//; s/"//g; s/'\''//g; s/\s*$//' | xargs)
        OUTDIR=$(grep -E "^\s*outdir\s*=" "$TOWER_CONFIG_FILE" | sed 's/.*=\s*//; s/"//g; s/'\''//g; s/\s*$//' | xargs)
        PIPELINE_INFO=$(grep -E "^\s*pipeline_info\s*=" "$TOWER_CONFIG_FILE" | sed 's/.*=\s*//; s/"//g; s/'\''//g; s/\s*$//' | xargs)
        
        echo "  input: ${INPUT:-[NOT FOUND]}"
        echo "  outdir: ${OUTDIR:-[NOT FOUND]}"
        echo "  pipeline_info: ${PIPELINE_INFO:-[NOT FOUND]}"
    else
        echo "  ✗ ERROR: File does not exist at that path"
    fi
else
    echo "  ✗ TOWER_CONFIG_FILE is NOT set"
fi

echo ""
echo "Listing all available environment variables with TOWER or NXF prefix:"
env | grep -E "^(TOWER_|NXF_)" | sort

echo ""
echo "=========================================="
echo "END OF POST-RUN SCRIPT"
echo "=========================================="
